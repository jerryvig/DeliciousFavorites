import java.util.List;
import java.util.LinkedList;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;
import java.sql.PreparedStatement;
import java.sql.Connection;
import java.sql.SQLException;
import javax.net.ssl.HttpsURLConnection;
import java.net.Authenticator;
import java.net.PasswordAuthentication;
import java.net.URL;
import java.net.MalformedURLException;
import org.dom4j.io.SAXReader;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.Node;
import java.util.concurrent.Executors;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Callable;
import javax.xml.parsers.SAXParserFactory;
import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLStreamReader;
import javax.xml.stream.XMLStreamException;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.ArrayBlockingQueue;

public class StartH2DeliciousSqlite {
    private static Connection conn;
    private static Statement stmt;
    private static PreparedStatement virtStmt;
    private static PreparedStatement iStmt;

    public static void main( String[] args ) {
       startDB();
       deliciousXML2H2();
       stopDB();
    }

    public static void startDB() {
	try {
	   Class.forName("org.sqlite.JDBC");
	} catch ( ClassNotFoundException cnfe ) { cnfe.printStackTrace(); }

	try {
	    conn = DriverManager.getConnection("jdbc:sqlite:/mnt/ramdisk/delicious.db");
	    stmt = conn.createStatement();
            stmt.executeUpdate("DROP TABLE IF EXISTS posts");
	    stmt.executeUpdate("CREATE TABLE posts (description TEXT,extended TEXT,hash TEXT,href TEXT,private INTEGER,shared INTEGER,tag TEXT,time TEXT)");
            stmt.executeUpdate("DROP TABLE IF EXISTS posts_fts3");
            stmt.executeUpdate("CREATE VIRTUAL TABLE posts_fts3 USING fts3( description TEXT, extended TEXT, href TEXT, tag TEXT )");
	} catch ( SQLException sqle ) { sqle.printStackTrace(); }
    }

    public static void deliciousXML2H2() {
	try {
	    Authenticator.setDefault(new Authenticator() {
		    public PasswordAuthentication getPasswordAuthentication() {
			String username = "agentq314";
			String password = "dk87nup4841";
			return new PasswordAuthentication(username,password.toCharArray());
		    }
	    });

            try {
              iStmt = conn.prepareStatement("INSERT INTO posts VALUES(?,?,?,?,?,?,?,?)"); 
            } catch ( SQLException sqle ) { sqle.printStackTrace(); }
            try {
		virtStmt = conn.prepareStatement("INSERT INTO posts_fts3 VALUES(?,?,?,?)");
            } catch ( SQLException sqle ) { sqle.printStackTrace(); }

            final ExecutorService execSvc = Executors.newFixedThreadPool(1);
            final LinkedList<Callable<Object>> nodeTasks = new LinkedList<Callable<Object>>();
            //final ArrayBlockingQueue<char> charQ = new ArrayBlockingQueue<char>(5);

	    URL url = new URL("https://agentq314:dk87nup4841@api.del.icio.us/v1/posts/all");
	    HttpsURLConnection urlConn = (HttpsURLConnection)(url.openConnection());
            InputStreamReader reader = new InputStreamReader(urlConn.getInputStream());
            char[] buffer5 = new char[2];
            char[] buffer2 = new char[2];
            
            int charCount = 0;
            int s = 0;
            while( (s=reader.read(buffer5,0,2)) != -1 ) {
	      if ( (new String(buffer5)).equals("<p") ) {
		 String postString = new String( buffer5 ); 
		 while ( (s=reader.read(buffer2,0,2)) != -1 ) {
                     postString = postString.concat( new String(buffer2) );
		     if ( (new String(buffer2)).equals("/>") ) {
			(new DeliciousPostProcessor(postString, iStmt, virtStmt)));
                        //System.out.println( postString );
                        postString = "";
                        break; 
                     } 
                 } 
	      }
            }
            reader.close();
            
            //System.out.println( "lineCount = " + lineCount );
           
            /*
            String postString = "";
            boolean addToPostString = false;

            for ( int i=0; i<content.length()-5; i++ ) {
	       if ( content.substring(i,i+5).equals("<post") ) addToPostString = true;
               if ( content.substring(i,i+2).equals("/>") ) {
                  nodeTasks.add(Executors.callable(new DeliciousPostProcessor(postString, iStmt, virtStmt)));
                  addToPostString = false;
                  postString = "";
               }
               if ( addToPostString ) postString += content.charAt(i);
	       } */
       
            try {
	       execSvc.invokeAll( nodeTasks );
	       execSvc.shutdown();
	    } catch ( InterruptedException ie ) { ie.printStackTrace(); }

	    try {
               conn.setAutoCommit(false);
               iStmt.executeBatch();
               virtStmt.executeBatch();
               conn.setAutoCommit(true);

	       stmt.executeUpdate("CREATE INDEX posts_tag_idx ON posts(tag)");
	       stmt.executeUpdate("CREATE INDEX posts_time_idx ON posts(time)");
               stmt.executeUpdate("CREATE INDEX posts_desc_idx ON posts(description)");
               stmt.executeUpdate("CREATE INDEX posts_ext_idx ON posts(extended)");
               stmt.executeUpdate("CREATE INDEX posts_private_idx ON posts(private)");
               stmt.executeUpdate("CREATE INDEX posts_shared_idx ON posts(shared)");
	    } catch ( SQLException sqle ) { sqle.printStackTrace(); }
	} catch ( IOException ioe ) { ioe.printStackTrace(); }
	// catch ( DocumentException doce ) { doce.printStackTrace(); }
        //catch ( XMLStreamException e ) { e.printStackTrace(); }
    }
 
    public static void stopDB() {
      try {
	  conn.close();
      } catch ( SQLException sqle ) {
	  sqle.printStackTrace(); 
      }
    }
}